---
- name: Set up squiddlebox
  hosts: squiddlebox
  gather_facts: no
  become: true
  tasks:
    - name: install squid
      apt:
        name:
          - squid
        state: present
    - name: configure squid
      copy:
        dest: /etc/squid/squid.conf
        content: |
          http_port 3128
          acl localnet src 192.168.0.0/16
          http_access allow localhost
          http_access allow localnet
      notify: restart squid
  handlers:
    - name: restart squid
      systemd:
        name: squid.service
        state: restarted

- name: Remove default route
  hosts: all:!squiddlebox
  gather_facts: no
  tasks:
    - name: remove the default route to ensure only connections through the proxy work
      raw: ip route del default
      # noqa 301
      become: true
